#!/bin/bash
set -euo pipefail

##
# Generate a commit message using Claude CLI and commit with vim editor

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Check we're in a git repo
if ! git rev-parse --git-dir >/dev/null 2>&1; then
    echo -e "${RED}Not a git repository${NC}"
    exit 1
fi

# Check for claude CLI
if ! command -v claude >/dev/null 2>&1; then
    echo -e "${RED}Claude CLI not found${NC}"
    exit 1
fi

# Check for staged changes
if git diff --cached --quiet; then
    echo -e "${RED}No staged changes to commit${NC}"
    exit 1
fi

# Build prompt
PROMPT="Generate a concise git commit message for these changes. Output only the commit message, nothing else. DO NOT add a Claude watermark to the commit message."
if [[ -n "${1:-}" ]]; then
    PROMPT="$PROMPT Additional context: $1"
fi

# Generate commit message
echo -e "${YELLOW}Generating commit message...${NC}"
MSG=$(git diff --cached | claude -p "$PROMPT") || {
    echo -e "${RED}Failed to generate commit message${NC}"
    exit 1
}

# Check for empty response
if [[ -z "$MSG" ]]; then
    echo -e "${RED}Claude returned empty response${NC}"
    exit 1
fi

# Write to temp file
TMPFILE=$(mktemp)
trap "rm -f $TMPFILE" EXIT
printf '%s\n' "$MSG" > "$TMPFILE"
printf '\n# Save to commit, clear file to abort\n' >> "$TMPFILE"

# Open in editor
${EDITOR:-vim} "$TMPFILE"

# Remove comment lines and check if empty
CONTENT=$(grep -v '^#' "$TMPFILE" | tr -d '[:space:]')
if [[ -z "$CONTENT" ]]; then
    echo -e "${RED}Commit aborted${NC}"
    exit 1
fi

# Commit
git commit --cleanup=strip -F "$TMPFILE"
echo -e "${GREEN}Committed successfully${NC}"
